@page "/Listusers"
@inherits AppComponentBase
@attribute [Authorize(Roles = "Admin,Manager")]

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4>لیست کاربران</h4>
                    <button class="btn btn-success" @onclick="AddUser">کاربر جدید</button>
                </div>
                <div class="card-body">
                    @if (ListUser.ListUser == null || ListUser.ListUser.Count == 0)
                    {
                        <div class="alert alert-info">هیچ کاربری ثبت نشده است.</div>
                    }
                    else
                    {
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>نام</th>
                                    <th>نام خانوادگی</th>
                                    <th>ایمیل</th>
                                    <th>نقش</th>
                                    <th>اقدامات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in ListUser.ListUser)
                                {
                                    <tr>
                                        <td>@user.FirstName</td>
                                        <td>@user.LastName</td>
                                        <td>@user.Email</td>
                                        <td>@user.Role</td>
                                        <td>
                                            <button class="btn btn-sm btn-info me-1" @onclick="() => EditUser(user)">ویرایش</button>
                                            <button class="btn btn-sm btn-info me-1" @onclick="() => ChangePasswordUser(user)">تغییر پسورد</button>
                                            @{

                                                if (user.Role!=UserRole.Admin)
                                                {
                                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteUser(user)">حذف</button>
                                                }
                                            }

                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ListUserDto ListUser = new ListUserDto();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await load();


    }
    protected async Task load()
    {
        ListUser = await _User.ListUser();
    }
    private void AddUser()
    {
        NavManager.NavigateTo("/Registeruser");
    }

    private void EditUser(UserDto user)
    {
        NavManager.NavigateTo($"/Updateuser/{user.Id}");
    }
    private void ChangePasswordUser(UserDto user)
    {
        NavManager.NavigateTo($"/ChangePassword/{user.Id}");
    }

    private async Task DeleteUser(UserDto user)
    {
        bool confirmed = await ConfirmService.Confirm("حذف کاربر", "آیا مطمئن هستید حذف شود؟");
        if (confirmed)
        {
            if (user.Role != UserRole.Admin)
            {
                await _User.DeleteUser(user.Id);
            }
            await load();
        }
        
    }
}
