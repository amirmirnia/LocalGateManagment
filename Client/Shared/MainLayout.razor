@inherits LayoutComponentBase
@inject ConfirmService ConfirmService

<Alert />
<ConfirmModal @ref="confirmModal" OnConfirmed="OnConfirmed" />

<div class="app-layout">
    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="flex items-center gap-md">
                <button class="btn btn-ghost btn-icon mobile-menu-toggle" @onclick="ToggleSidebar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <a href="/" class="navbar-brand">
                    <img id="logoheader" src="Img/hospad2.png" />
                    سرویس مدیریت آفلاین شهرک مسکونی-هوشپاد
                </a>
            </div>
            
            <ul class="navbar-nav">
                <li class="nav-item">
                    <button class="btn btn-ghost btn-icon" @onclick="ToggleTheme" title="Toggle Dark Mode">
                        @if (isDarkMode)
                        {
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                            </svg>
                        }
                        else
                        {
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                            </svg>
                        }
                    </button>
                </li>
                <li class="nav-item">
                    <button class="btn btn-ghost btn-icon" title="Notifications">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                        </svg>
                        <span class="notification-badge">3</span>
                    </button>
                </li>
                <li class="nav-item">
                    <div class="user-menu">
                        <button class="btn btn-ghost flex items-center gap-sm">
                            <div class="user-avatar">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                </svg>
                            </div>
                            <span class="user-name">Admin</span>
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar Navigation -->
    <aside class="sidebar @(sidebarCollapsed ? "collapsed" : "")">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Navigation</h3>
        </div>
        <nav class="sidebar-menu">
            <div class="sidebar-section">
                <div class="sidebar-section-title">میز کار</div>
                <a href="/" class="sidebar-link @(GetActiveClass("/"))">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    <span>داشبورد</span>
                </a>
@*                 <a href="/services" class="sidebar-link @(GetActiveClass("/services"))">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    <span>سرویس ها</span>
                </a> *@
                <a href="/test-inquire" class="sidebar-link @(GetActiveClass("/test-inquire"))">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                    <span>تست عملکرد</span>
                </a>
                <a href="/configurations" class="sidebar-link @(GetActiveClass("/configurations"))">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    <span>سرویس ها</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">آنالیز</div>
                <a href="/reports" class="sidebar-link @(GetActiveClass("/reports"))">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    <span>گزارش ورود</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">تنظیمات</div>
                <a href="/Listusers" class="sidebar-link @(GetActiveClass("/Listusers"))">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                    </svg>
                    <span>کاربران</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content @(sidebarCollapsed ? "full-width" : "")">
        <div class="content-wrapper">
            @Body
        </div>
    </main>
</div>


@code {
    private bool sidebarCollapsed = false;
    private bool isDarkMode = false;
    private string currentPath = "/";
    private ConfirmModal confirmModal;
    private EventCallback<bool> pendingCallback;


    protected override async Task OnInitializedAsync()
    {
        currentPath = NavigationManager?.Uri.Replace(NavigationManager.BaseUri, "/") ?? "/";
        // Initialize theme from localStorage
        var currentTheme = await JSRuntime.InvokeAsync<string>("ThemeManager.getCurrent");
        isDarkMode = currentTheme == "dark";

        ConfirmService.OnConfirm += async (title, message) =>
       {
           var tcs = new TaskCompletionSource<bool>();
           ShowConfirm(title, message, EventCallback.Factory.Create<bool>(this, (result) =>
           {
               tcs.SetResult(result);
           }));
           return await tcs.Task;
       };
    }

    public void ShowConfirm(string title, string message, EventCallback<bool> callback)
    {
        pendingCallback = callback;
        confirmModal.Show(title, message);
    }

    private async Task OnConfirmed(bool confirmed)
    {
        if (pendingCallback.HasDelegate)
        {
            await pendingCallback.InvokeAsync(confirmed);
        }
    }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;
    
    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        await JSRuntime.InvokeAsync<string>("ThemeManager.toggle");
    }

    private string GetActiveClass(string path)
    {
        return currentPath.StartsWith(path) && (path != "/" || currentPath == "/") ? "active" : "";
    }
}